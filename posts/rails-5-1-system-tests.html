<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>An Accumulation of Errors | Rails 5.1 System Tests</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Rails 5.1 System Tests">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/posts/rails-5-1-system-tests">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="An Accumulation of Errors">
  <meta property="og:image" content="/assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="/posts/rails-5-1-system-tests">
  <meta name="twitter:title" content="Rails 5.1 System Tests">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="/assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="/feed.xml" type="application/rss+xml" rel="alternate" title="An Accumulation of Errors Last 10 blog posts" />

  

  
    <link type="text/css" rel="stylesheet" href="/assets/dark.css">
  
</head>

<body>
  <main role="main">
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav reveal">
  <a href="/" class="header-logo" title="An Accumulation of Errors">An Accumulation of Errors</a>
  <ul class="header-links">
    
    
    
    
      <li>
        <a href="https://github.com/WendyBeth" target="_blank" title="GitHub">
          <span class="icon icon-social-github"></span>
        </a>
      </li>
    
    
    
    
    
    
      <li>
        <a href="mailto:wendybeth010@gmail.com" title="Email">
          <span class="icon icon-at"></span>
        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" target="_blank" title="RSS">
          <span class="icon icon-social-rss"></span>
        </a>
      </li>
    
  </ul>
</nav>

        <article class="article reveal">
          <header class="article-header">
            <h1>Rails 5.1 System Tests</h1>
            <p></p>
            <div class="article-list-footer">
              <span class="article-list-date">
                March 26, 2017
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  3 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/rails">rails</a>
                
                  <a href="/tag/edge-rails">edge-rails</a>
                
                  <a href="/tag/testing">testing</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p>So the thing that I geeked out over the hardest when sharing the release notes
for Rails 5.1 with my team was the idea of baked in Capybara integration for
system tests, which can handle the testing of JavaScript functionality and all
of its associated wonky database management havoc.</p>

<p>So Rails 5.1 starts with a new test helper file:</p>

<p><strong>test/application_system_test_case.rb</strong></p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">ApplicationSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using: :chrome</span><span class="p">,</span> <span class="ss">screen_size: </span><span class="p">[</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1400</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>So by default now Rails is shipping with system tests that we can use to test
JavaScript behavior, without adding <code class="highlighter-rouge">gem 'database_cleaner'</code> to our Gemfile or
worrying about database cleaning strategies. It uses Selenium Webdriver by
default, but offers support for headless drivers such as Poltergeist and Webkit.
The default browser is Chrome - which is at odds with Selenium’s default of
Firefox because Selenium cannot keep up with Firefox’s updates.</p>

<p>There’s a new test directory <strong>test/system</strong>, where we can write our first
system test to inherit from <code class="highlighter-rouge">ApplicationSystemTestCase</code>. I’m testing
registration functionality in my Little Library application that I wrote about
in a <a href="https://wendybeth.github.io/posts/exploring-rails-5-1-with-webpacker">previous blog
post</a>.</p>

<p><strong>test/system/user_profile_test.rb</strong></p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'application_system_test_case'</span>

<span class="k">class</span> <span class="nc">UserProfileTest</span> <span class="o">&lt;</span> <span class="no">ApplicationSystemTestCase</span>
  <span class="nb">test</span> <span class="s2">"registering as a new user"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">new_registration_path</span>

    <span class="n">fill_in</span> <span class="s1">'Email'</span><span class="p">,</span> <span class="ss">with: </span><span class="s1">'test@user.com'</span>
    <span class="n">fill_in</span> <span class="s1">'Password'</span><span class="p">,</span> <span class="ss">with: </span><span class="s1">'password'</span>
    <span class="n">fill_in</span> <span class="s1">'Password Confirmation'</span><span class="p">,</span> <span class="ss">with: </span><span class="s1">'password'</span>
    <span class="n">click_on</span> <span class="s1">'Create User'</span>

    <span class="n">assert_text</span> <span class="s1">'Successfully registered.'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>I had a couple of problems getting this to run. The first was that I initially
had <code class="highlighter-rouge">gem 'capybara', '~&gt; 2.7.0'</code> in my Gemfile. That blew up because it could
not find the file ‘minitest/capybara’ which is required by
<code class="highlighter-rouge">ActionDispatch::SystemTestCase</code>. I had to change the line to <code class="highlighter-rouge">gem 'capybara',
'~&gt; 2.13.0'</code> to get my next error.</p>

<p>Here, I had a problem with ChromeDriver. When I ran the test, it opened up
Chrome to a blank white screen, and then timed out and gave me an <code class="highlighter-rouge">EOFError</code>. I
ended up updating ChromeDriver:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ brew unlink chromedriver
$ brew install chromedriver
</code></pre>
</div>

<p>And my test ran!</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ bundle exec rake test:system
=&gt; # Running:
=&gt;
=&gt; Puma starting in single mode...
=&gt; * Version 3.8.2 (ruby 2.2.2-p95), codename: Sassy Salamander
=&gt; * Min threads: 0, max threads: 1
=&gt; * Environment: test
=&gt; * Listening on tcp://0.0.0.0:61508
=&gt; Use Ctrl-C to stop
=&gt; .
=&gt; Finished in 3.145245s, 0.3179 runs/s, 0.3179 assertions/s.
=&gt;
=&gt; 1 runs, 1 assertions, 0 failures, 0 errors, 0 skips
</code></pre>
</div>

<p>So it’s starting up its own server, which manages its own connection to the
database. Again, I’m having a hard time getting over the fact that I don’t have
to worry about that myself (I have a series of blog posts in the works which
covers how Rails tests interact with the test database, in which I did a lot of
research in order to understand what was going on behind the scenes - this has
all been abstracted away! Ah!).</p>

<p>I ended up writing another test for my login functionality. It caught a mistake
in a way I was not expecting:</p>

<p><a href="/assets/rails51-systemtest-failure-screenshot.png" class="fluidbox-trigger">
  <img src="/assets/rails51-systemtest-failure-screenshot.png" alt="A System Test Failure Screenshot" />
</a></p>

<p>This is thanks to a helper module included in <code class="highlighter-rouge">SystemTestCase</code> -
<code class="highlighter-rouge">ActionDispatch::SystemTesting::TestHelpers::ScreenshotHelper</code>. The method
<code class="highlighter-rouge">take_failed_screenshot</code> seems to be responsible here, as you can read at the
<a href="http://edgeapi.rubyonrails.org/classes/ActionDispatch/SystemTesting/TestHelpers/ScreenshotHelper.html">EdgeAPI
docs</a>.</p>

<p>Happy coding. :)</p>

          </div>

          <div class="article-share" style="display: none">
            
            <a href="" title="Share on Twitter" onclick="window.open('https://twitter.com/home?status=Rails 5.1 System Tests - /posts/rails-5-1-system-tests ', 'newwindow', 'width=500, height=225'); return false;" data-turbolinks="false">
              <svg enable-background="new 0 0 128 128" width="15px" version="1.1" viewBox="0 0 128 128" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="_x37__stroke"><g id="Twitter"><rect clip-rule="evenodd" fill="none" fill-rule="evenodd" height="128" width="128"/><path clip-rule="evenodd" d="M128,23.294    c-4.703,2.142-9.767,3.59-15.079,4.237c5.424-3.328,9.587-8.606,11.548-14.892c-5.079,3.082-10.691,5.324-16.687,6.526    c-4.778-5.231-11.608-8.498-19.166-8.498c-14.493,0-26.251,12.057-26.251,26.927c0,2.111,0.225,4.16,0.676,6.133    C41.217,42.601,21.871,31.892,8.91,15.582c-2.261,3.991-3.554,8.621-3.554,13.552c0,9.338,4.636,17.581,11.683,22.412    c-4.297-0.131-8.355-1.356-11.901-3.359v0.331c0,13.051,9.053,23.937,21.074,26.403c-2.201,0.632-4.523,0.948-6.92,0.948    c-1.69,0-3.343-0.162-4.944-0.478c3.343,10.694,13.035,18.483,24.53,18.691c-8.986,7.227-20.315,11.533-32.614,11.533    c-2.119,0-4.215-0.123-6.266-0.37c11.623,7.627,25.432,12.088,40.255,12.088c48.309,0,74.717-41.026,74.717-76.612    c0-1.171-0.023-2.342-0.068-3.49C120.036,33.433,124.491,28.695,128,23.294" fill-rule="evenodd" id="Twitter_1_"/></g></g></svg>
            </a>
            <a href="" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=/posts/rails-5-1-system-tests', 'newwindow', 'width=500, height=500'); return false;" data-turbolinks="false">
              <svg enable-background="new 0 0 128 128" width="15px" version="1.1" viewBox="0 0 128 128" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="_x31__stroke"><g id="Facebook_1_"><rect fill="none" height="128" width="128"/><path clip-rule="evenodd" d="M68.369,128H7.065C3.162,128,0,124.836,0,120.935    V7.065C0,3.162,3.162,0,7.065,0h113.871C124.837,0,128,3.162,128,7.065v113.87c0,3.902-3.163,7.065-7.064,7.065H88.318V78.431    h16.638l2.491-19.318H88.318V46.78c0-5.593,1.553-9.404,9.573-9.404l10.229-0.004V20.094c-1.769-0.235-7.841-0.761-14.906-0.761    c-14.749,0-24.846,9.003-24.846,25.535v14.246H51.688v19.318h16.681V128z" fill-rule="evenodd" id="Facebook"/></g></g></svg>
            </a>
            <a href="" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=/posts/rails-5-1-system-tests', 'newwindow', 'width=550, height=400'); return false;" data-turbolinks="false">
              <svg enable-background="new 0 0 128 128" version="1.1" viewBox="0 0 128 128" width="20px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="_x35__stroke"><g id="Google_Plus"><rect clip-rule="evenodd" fill="none" fill-rule="evenodd" height="128" width="128"/><path clip-rule="evenodd" d="M40.654,55.935v16.13    c0,0,15.619-0.021,21.979-0.021C59.189,82.5,53.834,88.194,40.654,88.194c-13.338,0-23.748-10.832-23.748-24.194    s10.41-24.194,23.748-24.194c7.052,0,11.607,2.483,15.784,5.944c3.344-3.35,3.065-3.828,11.573-11.877    c-7.222-6.586-16.822-10.6-27.357-10.6C18.201,23.273,0,41.507,0,64c0,22.493,18.201,40.727,40.654,40.727    c33.561,0,41.763-29.275,39.044-48.792H40.654z M113.912,56.742V42.628h-10.063v14.113H89.358v10.081h14.491v14.517h10.063V66.823    H128V56.742H113.912z" fill-rule="evenodd" id="Google_Plus_1_"/></g></g></svg>
            </a>
          </div>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script>
              (function() {
                  var d = document, s = d.createElement('script');
                  s.src = '//accumulatederrors.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          
        </article>
        <footer class="footer reveal">
  <p>
    Powered by <a href="https://jekyllrb.com/">Jekyll</a>.
    Prettified by <a href="https://github.com/nielsenramon/chalk">Chalk</a>.
  </p>
  <p>
    Opinions are my own and are not reflective of nor endorsed by my employer.
    <br/>
    But <a href="https://littlelines.com">my employer</a> rocks all the
    socks.
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ['Cormorant Garamond:700', 'Lato:300,400,700']
      }
    });
  </script>




<script type="text/javascript" src="/assets/vendor.js"></script>
<script type="text/javascript" src="/assets/application.js"></script>

</body>
</html>
